# I/O系统

[TOC]

## I/O控制方式

1. 程序查询：由CPU不断查询I/O设备是否做好准备
2. 程序中断：在I/O准备好后向CPU发送中断请求才予以响应
3. DMA：主存与I/O有直接数据通路，无需中断程序
4. 通道：系统有通道控制部件，挂载外设，主机执行I/O命令则启动有关通道，通道执行通道程序



## 外部设备

1. 鼠标键盘：适合中断控制方式
2. CRT显示器：
   1. 字符显示器：显示字符点阵，所需显示字符以ASCII存储在VRAM中
   2. 图形显示器：坐标点/矢量发送给矢量产生器，控制电子束的移动



## 外存储器

1. 磁盘：
   1. 磁头：有几面；柱面：一面有几圈；扇区：一圈有几个块
   2. 磁盘阵列：
      1. RAID0：无冗余无校验
      2. RAID1：镜像
      3. RAID2～5：奇偶/海明码
   3. 条带化：将连续数据分为等大小块，存储在不同磁盘中——用于实现RAID



## I/O接口

1. 主机侧通过I/O总线与CPU/主存相连
   1. 数据线在数据缓冲器/**控制寄存器**与内存/CPU传送数据
   2. 控制线用于发送读写信号
   3. 地址线用于给出访问IO接口中寄存器地址
2. IO控制逻辑需要对控制寄存器中命令字进行译码
3. 对数据缓冲寄存器、状态/控制寄存器的访问是通过指令完成的，成为I/O指令，为**特权指令**
4. 编址方式：
   1. 统一编址（存储器映射方式）：把I/O端口当作存储器单元访问
      1. 优点：不需要专门的输入输出指令，灵活方便
      2. 缺点：占用地址空间，使容量变小，速度较慢
   2. 独立编址（I/O映射方式）：I/O端口地址空间是独立的，无法从地址码形式上区分
      1. 优点：输入输出指令与存储器指令区别明显，清晰方便理解
      2. 缺点：指令少，只能对端口进行传送，增加控制复杂性



## I/O方式

### 程序查询方式

1. 完全由主机执行程序实现，不断询问外设，直到准备就绪
2. CPU阻塞等待，串行工作，速度慢



### 程序中断方式

1. 异常和中断的重要不同：
   * 异常是由特定指令执行中形成的；中断不和指令相关，也不阻止任何指令完成
   * 异常检测由CPU自身完成，不必有外界信号；中断CPU必须获取总线上的信息
2. 中断判优可用硬件和软件分别实现
3. CPU相应中断条件：中断源有中断请求、CPU允许中断、一条指令执行完毕
4. 中断隐指令：不是真正的一条指令，是硬件直接实现的
   1. 流程：关中断、保存断点、引出中断服务程序
5. 中断向量：中断类型号-中断服务程序的对应关系
   1. 中断向量地址：中断服务程序的**入口地址的地址**
6. 现场**由软件**保存到栈中；断点**由CPU**在中断响应开始时保存到栈或寄存器中
7. 在执行中断服务程序前可开中断来实现中断嵌套



### DMA方式

1. 特点：
   1. 主存地址确定/传送数据的计数都由硬件实现
   2. 传送开始前进行预处理，结束后通过中断进行后处理
2. 控制器：
   1. 传送长度计数器：记录传送数据的长度，计数溢出后传送完毕，自动发送中断请求
   2. 控制/状态逻辑：用于指定传送方向
3. 传送方式：
   1. 停止CPU访存：CPU在收到DMAC的停止信号后脱离总线，直到一块数据传送结束
   2. 周期挪用（窃取）：I/O和CPU同时访存，I/O挪用一个或几个存取周期，传送完后立即释放总线，单字传送
   3. DMA/CPU交替访存：前半CPU周期DMA访存，后半周期CPU访存，单字传送



## 零碎重点

1. 浮点数下溢可处理为0，上溢无法处理，会提出中断
2. 在存取周期末尾而非指令执行末尾检测DMA请求
3. 访管中断请求从用户态转变为核心态
4. 中断隐指令使中断触发器置0
5. CPU相应DMA请求的条件是当前机器周期执行完而非指令周期执行完
6. DMA传送前由设备驱动程序设置传送参数
7. 自陷处理完成后返回到陷阱指令的下一条指令执行
8. 内中断均为不可屏蔽；外中断由INTR信号线发出的为可屏蔽中断，由NMI信号线的则是不可屏蔽；**任何时候发生不可屏蔽中断都要中止现行程序的执行，转到中断服务程序**