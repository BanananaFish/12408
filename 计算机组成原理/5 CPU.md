# CPU

[TOC]

## CPU结构与功能

1. 运算器
   1. 暂存寄存器：暂存从主存读入的数据，对程序员透明
   2. 通用寄存器：位数取决于机器字长（方便操作）
   3. PSW（程序状态字寄存器）：参与并决定微操作的形成
2. 控制器
   1. 程序计数器（PC）：$位数=\log_2{\frac{主存地址空间}{指令字长}}$，例如：32位字长的，按字节编址的，内存地址空间32GB的，$PC位数=32-2=30$
   2. 微操作信号发生器：根据IR、PSW产生组合逻辑型与存储逻辑型两种控制信号
   3. MDR/MAR也算控制器内寄存器
3. n位CPU指数据总线有n位



## 指令执行过程

1. 指令周期：
   1. 标志触发器：
      * FE：取指周期
      * IND：间址周期
      * EX：执行周期
      * INT：中断周期（进栈操作为SP-1）
2. 指令周期的数据流
   1. ==四个周期的数据流顺序==
   2. 中断周期只有在出现中断时才会出现
   3. 指令执行方案：
      1. 单指令周期：所有指令采用相同的执行时间，短板效应
      2. 多指令周期：不同类型不同周期，仍然为串行
      3. 流水线：并行执行，最好情况一个周期一条指令



## 数据通路

1. 三态门：一种控制组件，能产生除了高/低电平的第三种「高电阻」电平，用于表示既不可读也不可写
2. **MUX**：S端选择其中一个输入端的信号输出



## CU 控制器

1. CPU的控制方式：
   1. 同步控制：系统有一统一时钟，电路简单，运行慢
   2. 异步控制：通过应答方式联络，运行速度快，复杂
   3. 联合控制：大部分同步，小部分异步
2. 硬布线控制单元设计（组合逻辑控制器）
   1. $微操作控制信号=机器周期\times节拍\times脉冲\times操作码\times机器状态条件$
3. 微程序控制器：$微操作\rightarrow微命令\rightarrow微指令\rightarrow微程序$
   1. 微命令是微操作的控制信号，微操作是微命令的执行过程
   2. 微周期是读取并执行一条微指令的时间
   3. 控制存储器由ROM实现，存放各指令对应的微程序
4. 微指令的编码
   1. **直接编码**：特定一位代表特定一种微指令，简单直接，并行性好，字长过长
   2. **字段直接编码**：分为若干小字段，**互斥的放同一字段，相容的放不同字段**，每个字段每种编码代表一个微命令
      1. 信息位不能太多，会增加译码时间
      2. 每个小段需要留出一个状态如000表示不操作
   3. 字段间接编码：微命令由另一字段的微命令解释（隐式编码）
5. 微指令的地址形成：
   1. 微指令下地址直接给出（断定方式）
   2. 根据机器指令的操作码形成，由微地址形成部件形成
      1. 增量形成，类似于PC+1
      2. 根据标志分支转移
      3. 通过网络测试形成
      4. 硬件直接产生（例如电源刚加电）
6. 微指令的格式：
   1. 水平型：类似于直接编码方式，一条指令定义执行并行的几种基本操作；微程序短，执行快，微指令长，编写麻烦
   2. 垂直型：类似于机器指令操作码，有微操作码、目的地址、源地址，一条一种基本操作；指令短、便于编写，微程序长，速度慢
   3. 混合：在垂直型上增加一些不复杂的并行操作
7. 动态微程序：能根据用户需求改变微程序，EPROM实现；毫微程序设计：再套一次娃，为微程序的二级控制器
8. 硬布线与微程序的特点：
   1. 硬布线速度取决于电路延迟，设计完成后不好添加新功能；RISC
   2. 微程序规整、可维护性强、速度没有硬布线快；CISC

9. ==典型题目==：写出硬布线的微操作命令/写出微程序的微操作命令



## 指令流水线

1. 流水线级数：分为三个阶段（取指、分析、执行）的为三级流水，四个阶段（取指令、指令译码、执行、写回）四级，五级流水（取指IF、指令译码ID、取操作数OF、执行EX、写回WB）

2. 流水线设计原则：流水段个数以**最复杂指令**所用功能段个数为准；长度以**最复杂操作**所花时间为准

   * 指令长度尽量一致，利于译码
   * 格式尽量规整，例如源寄存器位置相同，利于未知时直接取操作数
   * 采用Load/Store指令访存，其他不能访存，把地址计算/运算指令的执行规整在同一周期内，减少操作步骤
   * 在存储器中对齐存放，减少访问存储器次数

3. 流水线特点：

   1. 分解任务为子任务，并行提高速度
   2. 流水线每个功能段后跟一个缓冲寄存器（锁存器），保存本流水段执行结果，给下一流水段使用
   3. 连续任务才能发挥流水线的效率，要在软硬件配合流水线，提供连续工作
   4. 流水线有装入时间和排空时间，装入为第一个任务进入到离开的时间，排空为最后一个任务进入到离开的时间

4. 流水线分类

5. 流水线冲突：

   1. 资源冲突（结构冒险）：同时争用同一资源；解决：前访存时，后暂停一个时钟；分离数据/指令寄存器（L1 Cache）

   2. 数据冲突（数据冒险）：下一条指令用到上一条指令的结果（数据相关影响最大）

      1. 写后读：上一条存入下一条读出；先读后写则读出错误（旧）数据
      2. 读后写：上一条读出下一条写入；先写后读则读出错误（新）数据
      3. 写后写：上一条写，下一条写；下一条先写则不是最新值

      * 解决：阻塞（暂停数个周期）；设置数据旁路（不存回寄存器）；通过编译器调整顺序

   3. 控制冲突（控制冒险）：例如转移时需要知道地址

      * 解决：分支预测；提前形成条件码；预测转移成功/不成功的两种目标

6. ==流水线性能指标==：

   1. 吞吐率：$TP=\frac{n}{T_k}，n：任务数，T_k：所用时间$
   2. 加速比：$S=\frac{T_0}{T_k}，T_0：不使用流水线耗时，T_k：使用流水线耗时$
   3. 效率：$E=\frac{n个任务所占时空图面积}{时空图总面积}$



## 零碎重点

1. CPU中的专用寄存器：PC、IR、MDR、MAR、PSW
2. 中断周期只有在出现中断时才会出现
3. **指令和数据如何被区分？**一条指令的执行分为取指和执行，取指取出指令，执行取出操作数，可在不同阶段区分从主存中取出的数据类型
4. 中断周期前是执行周期，之后是下一条指令的取指周期
5. 某带中断的计算机有10种操作，采用微程序控制时，控制存储器中最少有12种微程序（10+中断+取指）
6. 按序流动的流水线只可能出现RAW；非按序流动可出现RAW、WAR、WAW

